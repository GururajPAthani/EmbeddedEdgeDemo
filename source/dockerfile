# --- Stage 1: Build Stage ---
FROM ubuntu:22.04 AS builder

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential cmake git wget \
        libasio-dev python3-dev libncurses-dev doxygen python3-pip && \
    rm -rf /var/lib/apt/lists/*

# Build CycloneDDS and idlc
WORKDIR /usr/src/cyclonedds
RUN git clone https://github.com/eclipse-cyclonedds/cyclonedds.git . && \
    mkdir build && cd build && \
    cmake -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DDDS_SECURITY=OFF -DBUILD_IDLC=ON .. && \
    make -j$(nproc) && \
    make install

# Copy application source
WORKDIR /app
COPY publisher.c subscriber.c MyData.idl /app/

# Generate C source files from IDL
RUN idlc MyData.idl

# Compile the applications
RUN gcc -o publisher publisher.c MyData.c -I/usr/local/include -L/usr/local/lib -lddsc -lpthread -lm -lrt
RUN gcc -o subscriber subscriber.c MyData.c -I/usr/local/include -L/usr/local/lib -lddsc -lpthread -lm -lrt

# --- Stage 2: Runtime Stage ---
FROM ubuntu:22.04

ENV LD_LIBRARY_PATH=/usr/local/lib

WORKDIR /usr/local/bin
COPY --from=builder /app/publisher /usr/local/bin/
COPY --from=builder /app/subscriber /usr/local/bin/
COPY --from=builder /usr/local/lib/libddsc.so.0 /usr/local/lib/

ENTRYPOINT ["/usr/local/bin/bash"]
